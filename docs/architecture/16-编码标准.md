# 16. 编码标准

## 基础架构标准

- **Monorepo Structure**: 所有代码必须遵循已定义的 apps/和 packages/结构
- **Component Pattern**: React 组件必须遵循已提供的模板
- **State Management**: 状态应通过领域特定的 Zustand stores 进行管理
- **Service Layer**: 所有 API 通信必须通过定义的服务层进行
- **Backend Pattern**: 后端服务必须遵循控制器-服务-仓库模式

## 开发环境 vs 生产环境差异分析

### 问题背景

在项目开发过程中，我们发现了一个重要现象：**代码在 Mac 开发环境中运行正常，但在 Docker 部署时出现大量编译错误**。这个差异揭示了开发环境和生产环境配置不一致的问题。

### 根本原因分析

#### 1. TypeScript 编译严格性差异

**开发环境（Mac）**：
- 使用 `ts-node` 或 `tsc --watch` 进行开发
- 可能启用了宽松的编译选项
- 运行时错误被忽略，只显示警告
- 热重载掩盖了某些配置问题

**Docker 部署环境**：
- 使用 `tsc --project tsconfig.prod.json` 进行严格编译
- 启用了 `"strict": true` 和严格的类型检查
- 任何类型错误都会导致构建失败
- 静态编译，所有依赖必须在编译时解析

#### 2. 模块解析和依赖注入差异

**开发环境（Mac）**：
- Node.js 模块解析更加宽松
- 可能存在隐式的依赖注入（通过全局变量或闭包）
- 运行时动态加载，错误延迟到实际调用时才发现

**Docker 部署环境**：
- 严格的模块导入/导出检查
- 依赖注入必须在编译时明确声明
- 编译时验证所有函数签名

#### 3. Prisma 客户端生成时机差异

**开发环境（Mac）**：
- 可能已经运行过 `prisma generate`
- 开发服务器重启时自动处理依赖
- 文件系统权限不是问题

**Docker 部署环境**：
- 需要在容器内重新生成 Prisma 客户端
- 权限问题（非 root 用户无法运行 `prisma generate`）
- 构建时和运行时的环境差异

#### 4. 中间件和路由处理差异

**开发环境（Mac）**：
- Express 中间件链可能更加宽容
- 参数传递错误可能被运行时忽略

**Docker 部署环境**：
- 严格的 TypeScript 类型检查
- 中间件参数不匹配直接导致编译失败

### 最佳实践标准

#### 1. 开发环境配置

```json
// tsconfig.dev.json
{
  "extends": "./tsconfig.json",
  "compilerOptions": {
    "strict": false,
    "noEmitOnError": false,
    "skipLibCheck": true
  }
}
```

#### 2. 生产环境配置

```json
// tsconfig.prod.json
{
  "extends": "./tsconfig.json",
  "compilerOptions": {
    "strict": true,
    "noEmitOnError": true,
    "skipLibCheck": false
  }
}
```

#### 3. 依赖注入模式

**推荐：明确的依赖注入**
```typescript
export const createRoutes = (prisma: PrismaClient) => {
  const controller = new Controller(prisma);
  // ... 路由配置
  return router;
};
```

**避免：模块级别的实例化**
```typescript
// ❌ 问题源 - 不要在模块级别实例化
const prisma = new PrismaClient();

// ✅ 正确做法 - 通过参数传递
export const authenticate = (prisma: PrismaClient) => asyncHandler(async (req, res, next) => {
  // ... 实现
});
```

#### 4. Docker 构建前检查

```bash
# 在本地运行生产构建检查
npm run build:prod

# 检查类型错误
npx tsc --noEmit --project tsconfig.prod.json

# 运行生产环境测试
NODE_ENV=production npm test
```

### 代码质量检查清单

在提交代码前，必须完成以下检查：

- [ ] 本地运行 `npm run build:prod` 成功
- [ ] 类型检查通过：`npx tsc --noEmit`
- [ ] 所有导入路径正确且明确
- [ ] 依赖注入模式正确实现
- [ ] 中间件参数匹配正确
- [ ] 控制器方法名与路由引用一致

### 环境一致性原则

1. **配置同步**：开发环境和生产环境使用相同的 TypeScript 配置
2. **严格检查**：在开发阶段就启用严格的类型检查
3. **依赖明确**：所有依赖关系必须在编译时明确声明
4. **测试覆盖**：生产构建必须在本地验证通过

### 常见问题及解决方案

#### 问题1：模块级别的 PrismaClient 实例化
**症状**：Docker 构建时出现权限错误
**解决**：改为依赖注入模式，通过参数传递 PrismaClient

#### 问题2：中间件参数不匹配
**症状**：TypeScript 编译错误 "Expected 3 arguments, but got 2"
**解决**：正确使用中间件函数，直接传递方法引用

#### 问题3：导入路径错误
**症状**：Cannot find module 错误
**解决**：检查相对路径，确保从正确的模块导入

### 总结

这些问题的根本原因是**开发环境和生产环境的配置差异**。为了避免类似问题：

1. **统一配置**：开发和生产环境使用相同的严格配置
2. **早期发现**：在开发阶段就发现和修复类型错误
3. **模式一致**：使用统一的依赖注入和中间件模式
4. **持续验证**：定期运行生产构建检查

通过遵循这些标准，可以确保代码在开发和生产环境中都能正常工作，避免部署时的意外错误。
