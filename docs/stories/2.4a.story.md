# Story 2.4a: (Web) 优化工单创建功能 - 故障表现驱动

## Status

PLANNING

## Story

**As a** 维护员工或技术人员,
**I want** 在Web界面使用优化后的工单创建流程，通过选择故障表现来报告设备问题,
**so that** 我可以更准确、高效地创建工单，与移动端体验保持一致，同时享受Web端的便利性。

## Acceptance Criteria

1. 在工单管理界面的右上角保留"创建工单"按钮，打开优化后的工单创建表单。
2. **工单创建表单优化** - 包含与移动应用界面一致的新字段结构：
   - **设备选择(设备)** - 必填，从设备主数据中选择需要维修的设备，支持搜索和筛选
   - **工单标题(标题)** - 必填，最少5个字符，提供智能建议
   - **故障表现选择(故障表现)** - 必填，多选，从预设故障现象列表选择：
     * 设备停机、断电、异常噪音、漏油/漏液、过热、振动异常、速度异常、显示异常、无法启动、功能失效、其他
     * 每个选项提供图标和简短描述
     * 支持快速搜索和筛选故障表现
   - **设备位置(位置)** - 从所选设备主数据自动获取，只读显示，带有位置图标
   - **补充位置信息(补充位置)** - 可选，用于特殊位置说明，placeholder提示示例
   - **造成生产中断** - 复选框，用于控制紧急优先级可用性
   - **优先级选择器(优先级)** - 低/中/高，紧急（仅在勾选生产中断时可选），带有优先级说明
   - **详细描述(描述)** - 可选，支持富文本或markdown
   - **故障照片(附件)** - 可选，支持多文件上传，拖拽上传，图片预览
3. **表单行为和验证**:
   - 设备选择后自动填充位置信息
   - 造成生产中断复选框控制紧急优先级的可用性
   - 取消勾选生产中断时，如果当前选择紧急优先级，自动降级为高优先级
   - 实时表单验证，错误消息清晰明确
   - 表单提交前的完整验证
4. **用户体验优化**:
   - 表单布局响应式，适配不同屏幕尺寸
   - 支持键盘快捷键操作（Ctrl+S保存，Esc关闭等）
   - 提供表单草稿自动保存功能
   - 智能字段建议和自动完成
5. **集成和兼容性**:
   - 表单数据提交到更新后的 `POST /api/work-orders` 端点
   - 与现有 work-order-store 和 work-order-service 无缝集成
   - 遵循现有的 Zustand 状态管理模式
   - 保持现有工单管理功能正常工作，无回归问题
6. **反馈和通知**:
   - 成功创建后显示工单详情（工单编号、预计处理时间等）
   - 错误处理与现有Web应用模式一致
   - 提供操作确认和取消机制
7. **无障碍和本地化**:
   - UI遵循现有设计模式和中文本地化
   - 支持无障碍访问（ARIA标签、键盘导航）
   - 响应式设计确保在各种设备上正常使用

## Tasks / Subtasks

- [ ] 更新工单创建表单组件 (AC: 2)
  - [ ] 重构 WorkOrderCreateForm.tsx 以支持新的字段结构
  - [ ] 实现故障表现多选组件，包含图标和描述
  - [ ] 创建设备选择器组件，支持搜索和筛选
  - [ ] 实现位置信息的自动填充和只读显示
  - [ ] 添加补充位置信息字段
  - [ ] 创建造成生产中断复选框组件

- [ ] 实现优先级规则控制 (AC: 3)
  - [ ] 实现优先级选择器的条件禁用逻辑
  - [ ] 添加优先级自动降级功能
  - [ ] 实现优先级说明和帮助文本
  - [ ] 更新表单状态管理以处理新的优先级规则

- [ ] 优化用户体验和界面 (AC: 4)
  - [ ] 实现响应式表单布局
  - [ ] 添加键盘快捷键支持
  - [ ] 实现表单草稿自动保存功能
  - [ ] 创建智能字段建议和自动完成
  - [ ] 优化文件上传组件，支持拖拽和预览

- [ ] 更新表单验证逻辑 (AC: 3, 6)
  - [ ] 重写表单验证规则以适应新字段结构
  - [ ] 实现实时验证和错误提示
  - [ ] 更新提交前的完整验证逻辑
  - [ ] 改进错误消息的清晰度和用户友好性

- [ ] 扩展状态管理和服务层 (AC: 5)
  - [ ] 更新 work-order-store.ts 中的 createWorkOrder 方法
  - [ ] 修改 work-order-service.ts 以支持新的API结构
  - [ ] 实现新数据模型的状态管理
  - [ ] 确保与现有工单管理功能的兼容性

- [ ] API集成和数据处理 (AC: 5)
  - [ ] 更新API请求格式以匹配新的后端期望
  - [ ] 实现多部分表单数据的正确处理（文件上传）
  - [ ] 更新响应处理逻辑
  - [ ] 实现错误处理和重试机制

- [ ] 无障碍和响应式设计 (AC: 7)
  - [ ] 添加适当的ARIA标签和无障碍属性
  - [ ] 实现键盘导航支持
  - [ ] 确保响应式设计在各种设备上正常工作
  - [ ] 验证中文本地化的完整性

- [ ] 集成测试和质量保证 (AC: 5, 6)
  - [ ] 验证现有工单列表和筛选功能无回归问题
  - [ ] 进行完整的工单创建到列表刷新的端到端测试
  - [ ] 测试与现有 Zustand 状态管理的集成
  - [ ] 验证错误处理和用户反馈的一致性

## Dev Notes

### 变更背景和目标

此故事是对现有 Story 2.4 的重大优化，旨在：

1. **保持平台一致性**: 与移动端的用户体验保持一致
2. **提升数据质量**: 使用故障表现替代主观的分类和原因
3. **简化用户操作**: 自动化位置信息，减少手动输入
4. **强化业务规则**: 通过优先级控制确保紧急工单的合理使用
5. **优化Web体验**: 充分利用Web平台的优势（大屏幕、键盘操作等）

### 技术架构更新

#### 1. 数据模型接口定义
```typescript
// 更新后的工单创建请求接口
interface CreateWorkOrderRequest {
  assetId: string;                    // 必填，设备ID
  title: string;                      // 必填，工单标题
  description?: string;               // 可选，详细描述
  faultSymptoms: FaultSymptom[];      // 必填，故障表现数组
  location: string;                   // 自动获取，只读
  additionalLocation?: string;        // 可选，补充位置信息
  productionInterrupted: boolean;     // 生产中断标记
  priority: Priority;                 // 优先级
  attachments?: File[];               // 可选，附件文件
}

// 故障表现枚举
enum FaultSymptom {
  EQUIPMENT_SHUTDOWN = 'equipment_shutdown',
  POWER_OUTAGE = 'power_outage',
  ABNORMAL_NOISE = 'abnormal_noise',
  LEAKAGE = 'leakage',
  OVERHEATING = 'overheating',
  ABNORMAL_VIBRATION = 'abnormal_vibration',
  SPEED_ABNORMALITY = 'speed_abnormality',
  DISPLAY_ERROR = 'display_error',
  CANNOT_START = 'cannot_start',
  FUNCTION_FAILURE = 'function_failure',
  OTHER = 'other'
}

// 故障表现配置
const FAULT_SYMPTOM_CONFIG = {
  [FaultSymptom.EQUIPMENT_SHUTDOWN]: {
    label: '设备停机',
    description: '设备完全停止运行',
    icon: 'power-off',
    color: 'red'
  },
  [FaultSymptom.POWER_OUTAGE]: {
    label: '断电',
    description: '设备失去电力供应',
    icon: 'zap-off',
    color: 'yellow'
  },
  // ... 其他故障表现配置
} as const;
```

#### 2. 表单组件架构
```typescript
// 主表单组件结构
const WorkOrderCreateForm: React.FC = () => {
  const [formData, setFormData] = useState<CreateWorkOrderRequest>({
    assetId: '',
    title: '',
    faultSymptoms: [],
    location: '',
    productionInterrupted: false,
    priority: Priority.MEDIUM,
  });

  // 设备选择处理
  const handleAssetChange = (asset: Asset) => {
    setFormData(prev => ({
      ...prev,
      assetId: asset.id,
      location: asset.location, // 自动填充位置
    }));
  };

  // 优先级规则控制
  const handleProductionInterruptedChange = (interrupted: boolean) => {
    setFormData(prev => ({
      ...prev,
      productionInterrupted: interrupted,
      // 如果取消勾选且当前是紧急，降级为高
      priority: !interrupted && prev.priority === Priority.URGENT
        ? Priority.HIGH
        : prev.priority
    }));
  };

  return (
    <form onSubmit={handleSubmit}>
      <AssetSelector onAssetChange={handleAssetChange} />
      <TitleInput value={formData.title} onChange={handleTitleChange} />
      <FaultSymptomsSelector
        selected={formData.faultSymptoms}
        onChange={handleFaultSymptomsChange}
      />
      <LocationDisplay location={formData.location} readonly />
      <AdditionalLocationInput
        value={formData.additionalLocation}
        onChange={handleAdditionalLocationChange}
      />
      <ProductionInterruptedCheckbox
        checked={formData.productionInterrupted}
        onChange={handleProductionInterruptedChange}
      />
      <PrioritySelector
        value={formData.priority}
        onChange={handlePriorityChange}
        urgentEnabled={formData.productionInterrupted}
      />
      <DescriptionTextarea
        value={formData.description}
        onChange={handleDescriptionChange}
      />
      <FileUploader
        files={formData.attachments}
        onChange={handleAttachmentsChange}
      />
    </form>
  );
};
```

#### 3. Zustand Store 更新
```typescript
// work-order-store.ts 更新
interface WorkOrderStore {
  // ... 现有状态
  createWorkOrder: (data: CreateWorkOrderRequest) => Promise<WorkOrder>;
  // ... 其他方法
}

const useWorkOrderStore = create<WorkOrderStore>((set, get) => ({
  // ... 现有实现

  createWorkOrder: async (data: CreateWorkOrderRequest) => {
    set({ isCreating: true, createError: null });

    try {
      const formData = new FormData();

      // 处理基本字段
      formData.append('assetId', data.assetId);
      formData.append('title', data.title);
      formData.append('faultSymptoms', JSON.stringify(data.faultSymptoms));
      formData.append('location', data.location);
      formData.append('productionInterrupted', data.productionInterrupted.toString());
      formData.append('priority', data.priority);

      // 处理可选字段
      if (data.description) formData.append('description', data.description);
      if (data.additionalLocation) formData.append('additionalLocation', data.additionalLocation);

      // 处理文件上传
      data.attachments?.forEach((file, index) => {
        formData.append(`attachments`, file);
      });

      const workOrder = await workOrderService.createWorkOrder(formData);

      // 更新本地状态
      set(state => ({
        workOrders: [workOrder, ...state.workOrders],
        isCreating: false,
        createError: null
      }));

      return workOrder;
    } catch (error) {
      set({
        isCreating: false,
        createError: error instanceof Error ? error.message : '创建工单失败'
      });
      throw error;
    }
  },
}));
```

### UI/UX 设计考虑

#### 1. 故障表现选择器设计
- **多选卡片布局**: 使用卡片样式，每个故障表现一个卡片
- **图标和描述**: 清晰的图标配合简短描述
- **搜索功能**: 快速筛选故障表现选项
- **分类组织**: 可以考虑按设备类型或故障类别分组

#### 2. 响应式布局策略
- **桌面端**: 两列布局，左侧基本信息，右侧故障详情
- **平板端**: 单列布局，优化触控操作
- **移动端**: 垂直堆叠，简化界面元素

#### 3. 键盘快捷键支持
- `Ctrl + S`: 保存工单
- `Ctrl + Enter`: 提交工单
- `Esc`: 关闭表单
- `Tab`: 智能字段导航

### 性能优化策略

1. **组件懒加载**: 大型组件（如文件上传器）按需加载
2. **表单状态优化**: 使用 useCallback 和 useMemo 优化渲染
3. **图片预览优化**: 图片压缩和缩略图生成
4. **API请求优化**: 防抖搜索，请求缓存

### 兼容性和迁移

#### 1. 向后兼容策略
- API端点支持新旧两种数据格式
- 前端代码通过功能开关控制新旧界面
- 数据库层面保持兼容性

#### 2. 数据迁移考虑
- 现有的 category 和 reason 数据如何映射到 faultSymptoms
- 历史工单的显示兼容性
- 用户习惯的过渡期支持

## Testing

### 测试策略

#### 1. 单元测试覆盖
- **表单组件测试**: 每个子组件的独立功能测试
- **状态管理测试**: Zustand store 的状态变更测试
- **验证逻辑测试**: 表单验证规则的各种场景测试
- **优先级规则测试**: 条件禁用和自动降级逻辑测试

#### 2. 集成测试范围
- **完整工单创建流程**: 从打开表单到成功创建的端到端测试
- **API集成测试**: 新数据格式的API调用测试
- **状态同步测试**: 表单状态与全局状态的同步测试
- **错误处理测试**: 各种错误场景的处理测试

#### 3. 用户体验测试
- **可用性测试**: 真实用户的操作体验测试
- **无障碍测试**: 屏幕阅读器和键盘导航测试
- **性能测试**: 大文件上传和复杂表单的性能测试
- **跨浏览器测试**: 主流浏览器的兼容性测试

#### 4. 回归测试
- **现有功能测试**: 确保现有工单管理功能无影响
- **数据完整性测试**: 新旧数据格式的兼容性测试
- **权限控制测试**: 角色权限的正确性验证

### 测试用例示例

```typescript
// 故障表现选择器测试
describe('FaultSymptomsSelector', () => {
  it('should allow multiple selection', () => {
    render(<FaultSymptomsSelector selected={[]} onChange={mockOnChange} />);

    fireEvent.click(screen.getByText('设备停机'));
    fireEvent.click(screen.getByText('断电'));

    expect(mockOnChange).toHaveBeenCalledWith([
      FaultSymptom.EQUIPMENT_SHUTDOWN,
      FaultSymptom.POWER_OUTAGE
    ]);
  });

  it('should require at least one selection', () => {
    render(<FaultSymptomsSelector selected={[]} onChange={mockOnChange} />);

    const submitButton = screen.getByRole('button', { name: '提交' });
    fireEvent.click(submitButton);

    expect(screen.getByText('请选择至少一个故障表现')).toBeInTheDocument();
  });
});

// 优先级规则测试
describe('Priority Rules', () => {
  it('should auto-downgrade urgent priority when production interrupted is unchecked', () => {
    const { result } = renderHook(() => useWorkOrderForm());

    act(() => {
      result.current.setProductionInterrupted(true);
      result.current.setPriority(Priority.URGENT);
    });

    expect(result.current.priority).toBe(Priority.URGENT);

    act(() => {
      result.current.setProductionInterrupted(false);
    });

    expect(result.current.priority).toBe(Priority.HIGH);
  });
});
```

## Change Log

| Date       | Version | Description                           | Author    |
| ---------- | ------- | ------------------------------------- | --------- |
| 2025-09-27 | 1.0     | 创建优化版Web端工单创建故事             | Sarah (PO) |

## Dependencies

### Prerequisites
- Story 2.4 的现有实现基础
- 后端API对新数据模型的支持（需要并行开发）
- 数据库模式更新完成
- 设备主数据API的位置信息支持

### Related Stories
- Story 2.4 (原始Web端工单创建) - 作为基础
- Story 1.4a (移动端对应优化) - 保持功能一致性
- 后端API更新故事 (需要创建) - 支持新的数据结构
- 设备管理功能增强 (可能需要) - 位置信息的完善

### Technical Dependencies
- ShadCN/UI 组件库的多选组件支持
- React Hook Form 或类似表单管理库的集成
- 文件上传组件的优化
- 响应式设计框架的更新

## Risk Assessment

### 高风险项
1. **用户接受度**: 界面变化较大，用户可能需要适应期
   - **缓解措施**: 提供用户培训，实现渐进式发布

2. **数据一致性**: 新旧数据格式的兼容性问题
   - **缓解措施**: 充分的数据迁移测试，保留回滚方案

3. **性能影响**: 复杂表单组件可能影响页面性能
   - **缓解措施**: 组件优化，懒加载，性能监控

### 中风险项
1. **API兼容性**: 后端变更可能影响现有功能
   - **缓解措施**: API版本控制，全面的集成测试

2. **浏览器兼容性**: 新的UI组件在不同浏览器中的表现
   - **缓解措施**: 跨浏览器测试，polyfill支持

### 低风险项
1. **本地化问题**: 中文文案的完整性
   - **缓解措施**: 文案审核，用户反馈收集

## Success Metrics

### 定量指标
- 工单创建成功率 > 98%
- 平均创建时间减少 20%（目标：从 3分钟减至 2.4分钟）
- 表单验证错误率减少 30%
- 用户满意度评分 > 4.2/5.0

### 定性指标
- 用户反馈工单创建更直观、简单
- 技术人员反映故障描述更准确、有用
- 管理层认为优先级设置更合理
- 无重大功能回归或数据丢失事件

### 业务指标
- 紧急工单的误用率降低 50%
- 工单信息完整性提升 25%
- 技术人员处理效率提升 15%
- 客户满意度间接提升