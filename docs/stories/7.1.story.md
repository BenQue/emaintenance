# Story 7.1: System Settings Management - Brownfield Addition

## Status

Approved

## Story

**As a** supervisor or admin,
**I want** a system settings interface to manage master data like equipment locations, fault codes, work order categories, and other configurable system parameters,
**So that** I can customize the system to match our organization's specific terminology and operational requirements without requiring code changes.

## Story Context

**Existing System Integration:**
- Integrates with: Work order validation system, user interface dropdowns, database schema
- Technology: Next.js frontend with shadcn/ui components, Express API endpoints, PostgreSQL with Prisma ORM
- Follows pattern: Existing management interfaces (User Management, Asset Management) using CRUD operations with tables and forms
- Touch points: `/apps/api/work-order-service/src/utils/validation.ts`, database enums, navigation system, form components

## Acceptance Criteria

**Functional Requirements:**
1. **Master Data Management Interface**: Create a `/dashboard/settings` page accessible to SUPERVISOR and ADMIN roles with sections for managing:
   - Work order categories (currently hardcoded in forms)
   - Equipment locations (currently using free-text Asset.location field)
   - Fault codes (currently using FaultCode enum)
   - Work order reasons (currently hardcoded in forms)
   - Priority levels (currently using Priority enum but could be customizable)

2. **CRUD Operations**: Each master data type supports Create, Read, Update, Delete operations with:
   - Add new entries with name and description fields
   - Edit existing entries (with validation for references)
   - Activate/deactivate entries (soft delete to preserve historical data)
   - View usage count (how many work orders/assets reference this entry)

3. **Database Integration**: Convert existing enum fields to reference configurable master data tables while maintaining data integrity and foreign key relationships

**Integration Requirements:**
4. Existing **work order creation and editing forms** continue to work unchanged with dropdowns populated from master data tables instead of hardcoded enums
5. New functionality follows existing **shadcn/ui component patterns** used in User Management and Asset Management pages
6. Integration with **work order validation system** maintains current validation rules but reads allowed values from database tables

**Quality Requirements:**
7. Change is covered by appropriate tests (API endpoint tests, component tests)
8. Navigation is updated to include Settings link for appropriate roles
9. No regression in existing work order creation, editing, or filtering functionality verified

## Technical Notes

- **Integration Approach**: 
  - Create new master data tables (Categories, Locations, FaultCodes, etc.) with foreign key relationships
  - Add new API endpoints following existing pattern in `/apps/api/user-service/src/controllers/`
  - Create settings management interface following User Management component structure
  - Update work order forms to fetch options from API instead of using hardcoded values

- **Existing Pattern Reference**: 
  - User Management interface at `/apps/web/components/users/UserList.tsx` 
  - API controller pattern in `/apps/api/user-service/src/controllers/UserController.ts`
  - Navigation integration pattern in `/apps/web/components/layout/Navigation.tsx`

- **Key Constraints**: 
  - Must maintain backward compatibility with existing work orders
  - Cannot break existing work order validation
  - Must preserve data integrity during enum-to-table migration
  - Settings changes should take effect immediately without requiring application restart

## Definition of Done

- [ ] Functional requirements met (master data management interface with full CRUD operations)
- [ ] Integration requirements verified (work order forms use dynamic master data, no breaking changes)
- [ ] Existing functionality regression tested (work order creation, editing, filtering work normally)
- [ ] Code follows existing patterns and standards (shadcn/ui components, API controller pattern)
- [ ] Tests pass (existing and new API/component tests)
- [ ] Documentation updated if applicable (navigation structure, API endpoints)

## Risk Assessment

**Primary Risk**: Database schema changes to convert enums to configurable tables could break existing work order validation and create data inconsistency

**Mitigation**: 
- Implement migration scripts to preserve existing enum values as initial master data entries
- Add database constraints to ensure referential integrity
- Use feature flags to gradually roll out the changeover from enums to tables
- Maintain validation compatibility by updating validation schemas to check against master data tables

**Rollback**: 
- Keep backup of original enum values
- Database migration can be reversed by restoring enum fields and removing master data tables
- Frontend components can fall back to hardcoded values if API endpoints fail

## Compatibility Verification

- ✅ **No breaking changes to existing APIs**: New settings APIs are additive; existing work order APIs maintain same interface
- ✅ **Database changes are additive only**: New master data tables added; existing work order records preserved with migration to reference IDs
- ✅ **UI changes follow existing design patterns**: Settings interface uses same shadcn/ui components as User Management and Asset Management
- ✅ **Performance impact is negligible**: Additional database joins for master data lookups are minimal; can be optimized with proper indexing

## Tasks / Subtasks

- [x] Database Schema Design and Migration (AC: 3)
  - [x] Create master data tables (Categories, Locations, FaultCodes, Reasons, Priorities)
  - [x] Design foreign key relationships with WorkOrder table
  - [x] Create migration scripts to populate tables with existing enum values
  - [x] Update WorkOrder table to reference master data tables
  - [x] Add database indexes for performance optimization

- [x] Backend API Implementation (AC: 4, 6)
  - [x] Create settings service following existing pattern in `/apps/api/user-service/`
  - [x] Implement CRUD controllers for each master data type
  - [x] Add authentication and authorization middleware
  - [x] Update work order validation to use master data tables
  - [x] Implement usage count endpoints for reference tracking

- [x] Frontend Settings Interface (AC: 1, 2, 5)
  - [x] Create `/dashboard/settings` page component
  - [x] Implement master data list views using shadcn/ui table components
  - [x] Create forms for CRUD operations using existing form patterns
  - [x] Add navigation link for SUPERVISOR and ADMIN roles
  - [x] Implement soft delete functionality with activate/deactivate controls

- [x] Form Integration Updates (AC: 4)
  - [x] Update work order creation forms to fetch dynamic options
  - [x] Update work order editing forms to use master data dropdowns
  - [x] Update asset forms to use dynamic location options
  - [x] Ensure backward compatibility with existing form validation

- [ ] Testing and Quality Assurance (AC: 7, 9)
  - [ ] Write unit tests for new API endpoints
  - [ ] Create component tests for settings interface
  - [ ] Perform regression testing on work order workflows
  - [ ] Test data migration and rollback procedures
  - [ ] Verify performance impact of master data lookups

## Dev Notes

### Current System Analysis

**Hardcoded Master Data Identified:**

1. **Work Order Categories**: Currently hardcoded in form components, need to be configurable
2. **Equipment Locations**: Free-text field in Asset model, should be dropdown from master data
3. **Fault Codes**: Enum in database schema, should be configurable table
4. **Work Order Reasons**: Hardcoded in validation, should be master data
5. **Priority Levels**: Enum that could benefit from customization

**Integration Points:**

- Work order forms: `/apps/web/components/work-orders/WorkOrderCreateForm.tsx`
- Asset forms: `/apps/web/components/assets/AssetForm.tsx`
- Validation: `/apps/api/work-order-service/src/utils/validation.ts`
- Database schema: `/packages/database/prisma/schema.prisma`

**Existing Patterns to Follow:**

- User management CRUD: `/apps/web/components/users/UserList.tsx`
- API controller structure: `/apps/api/user-service/src/controllers/UserController.ts`
- Navigation integration: `/apps/web/components/layout/Navigation.tsx`

### Estimated Development Time

**Single Development Session**: 3-4 hours focused work
- Database schema: 45 minutes
- Backend API: 90 minutes
- Frontend interface: 90 minutes
- Integration testing: 30 minutes

### Success Criteria Validation

The story creation is successful when:

1. ✅ Enhancement is clearly defined and appropriately scoped for single session
2. ✅ Integration approach is straightforward and low-risk
3. ✅ Existing system patterns are identified and will be followed
4. ✅ Rollback plan is simple and feasible
5. ✅ Acceptance criteria include existing functionality verification

## Change Log

| Date       | Version | Description                           | Author                    |
| ---------- | ------- | ------------------------------------- | ------------------------- |
| 2025-08-17 | 1.0     | Initial brownfield story creation     | Claude (brownfield-create-story task) |

## Implementation Notes

This story follows the brownfield-create-story task pattern for small, focused enhancements that integrate with existing system patterns. The enhancement adds configurable master data management without requiring architectural changes or complex design work.

**Key Success Factors:**
- Follows existing User Management interface patterns exactly
- Uses established API controller and database patterns
- Maintains full backward compatibility
- Can be completed in a single focused development session
- Has clear rollback procedures

**Post-Implementation Benefits:**
- Eliminates hardcoded master data throughout the system
- Provides administrators with self-service configuration capabilities
- Improves system flexibility for different organizational requirements
- Maintains data integrity while enabling customization