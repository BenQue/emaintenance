# 4. 史诗详情 - Epic 4: Web端用户登录界面

## 史诗概述

**史诗目标**: 这个史诗的目标是为 Web 应用实现完整的用户登录和认证流程。虽然后端认证 API 已在史诗 1 中实现，但 Web 端仍缺少登录界面。完成后，用户将能够通过 Web 界面安全登录系统，根据其角色访问相应功能。

**史诗类型**: Authentication & UI Epic (认证与界面史诗)

**估计工作量**: 3 个故事

## 业务价值

### 问题陈述

当前Web应用缺乏完整的用户认证界面，存在以下问题：
1. **缺乏用户入口**: Web端用户无法通过界面进行身份验证
2. **认证流程不完整**: 前端缺乏完整的认证状态管理
3. **访问控制缺失**: 受保护页面没有有效的访问控制机制
4. **用户体验断层**: 认证流程与主应用界面脱节

### 解决方案

通过实现完整的Web端登录系统，包括登录页面、认证流程管理、路由保护和用户界面集成，为Web用户提供安全便捷的系统访问体验。

### 预期收益

- **安全访问**: 建立完整的Web端身份验证和授权机制
- **用户体验**: 提供流畅的登录到应用使用的完整流程
- **角色管理**: 根据用户角色提供差异化的功能访问
- **状态维护**: 可靠的用户会话管理和状态持久化

## 功能需求

### 核心功能

1. **登录页面实现**
   - 响应式登录表单界面
   - 表单验证和错误处理
   - 加载状态和用户反馈
   - 品牌元素集成

2. **认证流程管理**
   - JWT令牌管理和存储
   - 自动认证状态检测
   - 令牌过期处理
   - 登出功能实现

3. **路由保护机制**
   - 基于认证状态的访问控制
   - 角色基础的页面重定向
   - 自动登录状态恢复
   - 会话状态持久化

## 技术规范

### 架构设计

**前端技术栈**:
- Next.js App Router 路由系统
- ShadCN/UI 组件库
- Zustand 状态管理
- TypeScript 类型安全

**认证策略**:
- JWT令牌存储在localStorage
- API请求自动附加Bearer令牌
- 令牌过期自动清理机制
- 客户端状态与服务端同步

### 状态管理设计

**认证Store结构**:
```typescript
interface AuthState {
  user: User | null
  token: string | null
  isAuthenticated: boolean
  isLoading: boolean
  login: (email: string, password: string) => Promise<void>
  logout: () => void
  checkAuth: () => void
  clearError: () => void
  error: string | null
}
```

**用户角色路由映射**:
```typescript
const ROLE_ROUTES = {
  EMPLOYEE: '/dashboard/work-orders',
  TECHNICIAN: '/dashboard/my-tasks', 
  SUPERVISOR: '/dashboard',
  ADMIN: '/dashboard'
}
```

### API集成

**认证服务接口**:
```typescript
interface AuthService {
  login(credentials: LoginCredentials): Promise<AuthResponse>
  logout(): Promise<void>
  refreshToken(): Promise<AuthResponse>
  validateToken(): Promise<boolean>
}
```

**API客户端配置**:
- 自动令牌附加中间件
- 401错误自动处理
- 令牌刷新机制
- 网络错误处理

## 故事分解

### 故事 4.1: 登录页面实现

**作为一个** 系统用户（员工、技术员、主管、管理员）,
**我想要** 通过一个专门的登录页面输入我的凭证进行身份验证,
**以便于** 我可以安全地访问系统并使用与我角色相关的功能。

**验收标准**:
- 创建 `/login` 路由和登录页面组件
- 页面包含邮箱/用户名和密码输入框，使用 ShadCN/UI 组件
- 实现表单验证，确保必填字段不为空
- 登录按钮在请求期间显示加载状态
- 登录失败时显示清晰的错误消息（如"用户名或密码错误"）
- 登录成功后自动跳转到 dashboard 页面

### 故事 4.2: 认证流程集成

**作为一个** 前端开发人员,
**我想要** 实现一个完整的认证流程，包括 token 管理和状态维护,
**以便于** 系统能够安全地处理用户会话并在后续请求中自动附加认证信息。

**验收标准**:
- 创建 `auth-service.ts` 服务，封装对后端 `/api/auth/login` 端点的调用
- 创建 `auth-store.ts` 使用 Zustand 管理用户认证状态
- JWT token 安全存储在 localStorage 中（后续可升级为 httpOnly cookies）
- API 客户端自动在请求头中附加 Bearer token
- 实现 token 过期检测和自动清理机制
- 提供登出功能，清理 token 和用户状态

### 故事 4.3: 路由保护和用户界面集成

**作为一个** 系统用户,
**我想要** 系统能够根据我的登录状态自动控制页面访问权限,
**以便于** 未登录用户无法访问受保护的页面，同时我能够看到自己的登录状态。

**验收标准**:
- 创建认证检查的布局组件，保护 `/dashboard` 路由
- 未登录用户访问受保护页面时自动重定向到 `/login`
- 登录后根据用户角色重定向到相应页面：
  - EMPLOYEE: `/dashboard/work-orders`
  - TECHNICIAN: `/dashboard/my-tasks`
  - SUPERVISOR/ADMIN: `/dashboard`
- 在导航栏显示当前登录用户的名称和角色
- 导航栏包含"退出登录"按钮，点击后清理认证状态并返回登录页
- 页面刷新后保持登录状态（读取存储的 token）

## 用户界面设计

### 登录页面设计

**布局结构**:
- 居中的登录卡片
- 公司Logo和品牌元素
- 简洁的表单设计
- 响应式移动端适配

**表单元素**:
- 邮箱/用户名输入框
- 密码输入框（带显示/隐藏切换）
- 记住我复选框（可选）
- 登录按钮（带加载状态）
- 错误消息显示区域

**交互设计**:
- 实时表单验证
- 平滑的动画过渡
- 清晰的错误提示
- 无障碍访问支持

### 导航栏用户状态

**用户信息显示**:
- 用户头像或初始字母
- 用户姓名和角色标识
- 下拉菜单包含用户选项

**用户菜单选项**:
- 个人资料设置
- 修改密码
- 退出登录
- 帮助支持

## 安全考虑

### 认证安全

**密码安全**:
- 前端不存储明文密码
- HTTPS传输加密
- 强密码策略提示

**令牌安全**:
- JWT令牌定期轮换
- 客户端自动清理过期令牌
- 敏感操作二次验证

**会话管理**:
- 非活跃会话自动过期
- 多设备登录检测
- 异常登录提醒

### 访问控制

**路由保护**:
- 白名单机制确保安全默认
- 角色基础的功能访问控制
- 动态权限验证

**API安全**:
- 所有API请求携带有效令牌
- 服务端令牌验证
- 权限不足的友好提示

## 验收标准

### 功能验收

1. ✅ **登录流程**: 用户可以成功登录并重定向到正确页面
2. ✅ **认证管理**: 令牌正确存储和管理，API调用自动授权
3. ✅ **路由保护**: 未授权访问正确拦截，角色权限有效
4. ✅ **状态持久**: 页面刷新后登录状态正确恢复

### 质量验收

5. ✅ **用户体验**: 登录流程流畅，错误提示清晰
6. ✅ **安全性**: 令牌安全存储，敏感信息不泄露
7. ✅ **性能**: 认证检查快速，不影响页面加载
8. ✅ **兼容性**: 跨浏览器兼容，移动端响应式正常

## 错误处理策略

### 登录错误处理

**网络错误**:
- 网络连接失败提示
- 服务器无响应处理
- 超时重试机制

**认证错误**:
- 用户名或密码错误
- 账户被锁定提示
- 账户不存在处理

**系统错误**:
- 服务器内部错误
- 维护模式提示
- 降级功能提供

### 会话错误处理

**令牌过期**:
- 自动跳转登录页
- 提示会话过期
- 保存当前页面状态

**权限不足**:
- 友好的权限提示
- 联系管理员引导
- 返回安全页面

## 风险评估与缓解

### 主要风险

**风险**: 客户端令牌存储可能存在XSS攻击风险

**缓解措施**:
- 实施严格的CSP策略
- 定期令牌轮换机制
- 敏感操作服务端二次验证

**风险**: 单点登录失败可能导致整个系统无法使用

**缓解措施**:
- 实施健壮的错误处理机制
- 提供离线降级功能
- 建立紧急访问通道

### 质量保证

- 认证流程的完整性测试
- 不同角色的权限验证测试
- 令牌过期和刷新的边界测试
- 跨浏览器和设备的兼容性测试

## 成功标准

史诗完成的标准:

1. ✅ Web端用户可以安全便捷地登录系统
2. ✅ 认证状态管理稳定可靠
3. ✅ 路由保护机制有效防护
4. ✅ 用户体验流畅一致
5. ✅ 安全性和性能达到预期要求

## 变更记录

| 日期 | 版本 | 描述 | 作者 |
|------|------|------|------|
| 2025-08-17 | 1.0 | 从综合史诗详情文档中提取创建独立Epic 4文件 | John, PM |

## 备注

此史诗是Web应用用户体验的重要基础，其实现质量直接影响用户对系统的第一印象和日常使用感受。重点关注安全性和用户体验的平衡，确保既能提供强有力的安全保护，又能维持流畅的使用体验。