# 工单号码生成需求变更文档

## 变更概述

**变更日期**: 2025-09-09
**变更类型**: 功能增强
**影响级别**: 中等
**变更发起人**: 产品需求

## 背景与问题

### 当前状态
- 工单系统使用自动生成的CUID作为工单标识符
- 缺少业务友好的工单号码，不便于用户引用和沟通
- 运维和维修人员需要简洁、规律的工单编号进行日常管理

### 业务痛点
1. **沟通困难**: CUID格式复杂，不便于电话或书面沟通
2. **缺乏规律**: 无法通过编号判断工单创建时间
3. **查找不便**: 用户难以记忆和快速查找特定工单
4. **报表统计**: 无法通过编号进行年度或周期性统计分析

## 需求规格

### 功能需求

#### FR-1: 工单号码格式规范
- **格式**: `MO + YYYY + NNNNN`
- **组成说明**:
  - `MO`: 固定前缀，表示"Maintenance Order"
  - `YYYY`: 4位年份，工单创建年份
  - `NNNNN`: 5位流水号，从00001开始递增
- **示例**: 
  - 2025年第一个工单: `MO2025000001`
  - 2025年第100个工单: `MO2025000100`
  - 2025年第10000个工单: `MO202510000`
  - 2026年第一个工单: `MO202600001`

#### FR-2: 流水号自动生成
- 系统自动为每个新工单分配递增的流水号
- 支持高并发环境下的唯一性保证
- 流水号在数据库层面保证原子性操作

#### FR-3: 年度重置机制
- 每年1月1日，流水号自动重置为00001
- 历史工单号码保持不变，确保数据完整性
- 支持跨年度的工单号码唯一性
- 每年最多支持99999个工单，避免号码溢出

#### FR-4: 向后兼容
- 现有工单的CUID保持不变，继续作为主键
- 新增`workOrderNumber`字段，不影响现有业务逻辑
- API接口同时支持CUID和工单号码查询

### 非功能需求

#### NFR-1: 性能要求
- 工单号码生成时间 < 50ms
- 支持并发创建100个工单/秒
- 数据库查询性能不受影响

#### NFR-2: 可靠性要求
- 工单号码生成成功率 99.9%
- 在系统故障恢复后，流水号延续正确
- 支持数据库事务回滚时的号码回收

#### NFR-3: 扩展性要求
- 支持未来可能的编号格式调整
- 预留多租户场景下的前缀定制能力

## 技术设计

### 数据模型变更

#### WorkOrder表变更
```sql
-- 在现有WorkOrder表中添加工单号码字段
ALTER TABLE "WorkOrder" 
ADD COLUMN "workOrderNumber" VARCHAR(11) UNIQUE NOT NULL;

-- 为工单号码添加索引以提升查询性能
CREATE INDEX "idx_work_order_number" ON "WorkOrder"("workOrderNumber");
```

#### 新增WorkOrderSequence表
```sql
-- 创建年度流水号跟踪表
CREATE TABLE "WorkOrderSequence" (
  "year" INTEGER PRIMARY KEY,
  "sequence" INTEGER NOT NULL DEFAULT 0,
  "lastUpdated" TIMESTAMP NOT NULL DEFAULT NOW(),
  "createdAt" TIMESTAMP NOT NULL DEFAULT NOW()
);

-- 初始化当前年度记录
INSERT INTO "WorkOrderSequence" ("year", "sequence") 
VALUES (EXTRACT(YEAR FROM NOW()), 0);
```

### 服务层实现

#### 工单号码生成服务
```typescript
class WorkOrderNumberService {
  /**
   * 生成新的工单号码
   * @returns Promise<string> 格式: MO + YYYY + NNNN
   */
  async generateWorkOrderNumber(): Promise<string> {
    const year = new Date().getFullYear();
    
    // 使用数据库事务确保原子性
    return await this.prisma.$transaction(async (tx) => {
      // 获取或创建年度序列记录
      let sequence = await tx.workOrderSequence.findUnique({
        where: { year }
      });
      
      if (!sequence) {
        sequence = await tx.workOrderSequence.create({
          data: { year, sequence: 0 }
        });
      }
      
      // 递增序列号
      const updatedSequence = await tx.workOrderSequence.update({
        where: { year },
        data: { 
          sequence: { increment: 1 },
          lastUpdated: new Date()
        }
      });
      
      // 生成工单号码
      const paddedSequence = updatedSequence.sequence.toString().padStart(5, '0');
      return `MO${year}${paddedSequence}`;
    });
  }
}
```

### API接口变更

#### 工单创建接口
```typescript
// POST /api/work-orders
{
  "title": "空调噪音问题",
  "description": "...",
  "assetId": "...",
  // workOrderNumber 将由系统自动生成
}

// Response
{
  "id": "clxxx...", // 原有CUID
  "workOrderNumber": "MO202500001", // 新增工单号码
  "title": "空调噪音问题",
  // ... 其他字段
}
```

#### 工单查询接口增强
```typescript
// 支持通过工单号码查询
GET /api/work-orders/MO202500001
GET /api/work-orders?workOrderNumber=MO202500001

// 原有CUID查询继续支持
GET /api/work-orders/clxxx...
```

## 实施计划

### 第一阶段: 数据库变更 (1天)
1. 创建数据库迁移脚本
2. 为现有工单生成历史工单号码
3. 添加必要的数据库索引

### 第二阶段: 服务层实现 (2天)
1. 实现工单号码生成服务
2. 修改工单创建逻辑
3. 添加号码查询支持
4. 编写单元测试

### 第三阶段: API接口更新 (1天)
1. 更新工单创建API返回值
2. 添加工单号码查询支持
3. 更新API文档

### 第四阶段: 前端界面调整 (2天)
1. 工单列表显示工单号码
2. 工单详情页展示工单号码
3. 搜索功能支持工单号码
4. 更新用户界面文案

### 第五阶段: 测试与发布 (2天)
1. 集成测试
2. 性能测试
3. 用户验收测试
4. 生产环境发布

## 风险评估

### 主要风险

#### R1: 数据迁移风险
- **风险**: 为现有工单生成历史号码时可能出现数据不一致
- **缓解**: 
  - 在维护窗口期间进行迁移
  - 提前备份数据库
  - 逐步验证迁移结果

#### R2: 并发冲突风险
- **风险**: 高并发创建工单时可能出现号码冲突
- **缓解**: 
  - 使用数据库事务保证原子性
  - 实施重试机制
  - 压力测试验证

#### R3: 向后兼容风险
- **风险**: 现有API调用方可能依赖特定的返回格式
- **缓解**: 
  - 保持原有字段不变
  - 新增字段采用可选方式
  - 提供过渡期支持

### 回退方案
- 保留原有CUID作为主键，确保核心功能不受影响
- 工单号码字段设计为可选，可以临时禁用
- 准备数据库回滚脚本

## 验收标准

### 功能验收
1. ✅ 新创建的工单自动分配正确格式的工单号码
2. ✅ 工单号码在年内唯一递增，跨年正确重置
3. ✅ API支持通过工单号码和CUID两种方式查询
4. ✅ 前端界面正确显示和搜索工单号码
5. ✅ 现有工单功能完全不受影响

### 性能验收
6. ✅ 工单创建响应时间增加 < 10%
7. ✅ 并发创建100个工单无冲突
8. ✅ 工单查询性能保持现有水平

### 质量验收
9. ✅ 单元测试覆盖率 > 90%
10. ✅ 集成测试通过
11. ✅ 代码审查通过
12. ✅ 文档更新完整

## 成功度量

- 工单号码生成成功率: 99.9%
- 用户查找工单时间减少: 30%
- 客服处理工单相关查询效率提升: 25%
- 系统无因号码冲突导致的故障

## 后续优化

### 短期优化 (1个月内)
- 根据用户反馈调整号码格式
- 优化查询性能
- 添加号码统计和分析功能

### 中期优化 (3个月内)
- 支持自定义前缀配置
- 添加号码格式验证
- 实现号码预留和回收机制

### 长期优化 (6个月内)
- 支持多租户场景下的独立编号
- 实现智能号码分配策略
- 添加号码使用情况分析报表

## 变更审批

| 角色 | 姓名 | 审批状态 | 审批时间 |
|------|------|----------|----------|
| 产品经理 | - | 待审批 | - |
| 技术负责人 | - | 待审批 | - |
| 项目经理 | - | 待审批 | - |

## 相关文档

- [Epic 2: 工单管理与处理](./Epic-2-工单管理与处理.md)
- [数据库设计文档](../architecture/4-数据模型.md)
- [API接口规范](../api/work-order-api.md)

---

**文档版本**: 1.0  
**最后更新**: 2025-09-09  
**下次审查**: 2025-09-16