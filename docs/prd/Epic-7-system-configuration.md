# 7. 史诗详情 - Epic 7: 系统配置与主数据管理

## 史诗概述

**史诗目标**: 为管理员和主管提供系统主数据配置功能（设备位置、故障代码、工单分类等），将硬编码的枚举值转换为可配置的数据表，提供组织级定制能力而无需代码修改。

**史诗类型**: Brownfield Enhancement

**估计工作量**: 1 个故事 (3-4小时开发时间)

## 业务价值

### 问题陈述

当前系统使用硬编码的枚举值处理主数据（故障代码、优先级、工单分类等），这导致：

1. **缺乏灵活性**: 组织无法根据自身需求定制系统术语和分类
2. **维护困难**: 任何主数据变更都需要代码修改和系统重新部署
3. **标准化不足**: 不同组织的操作需求无法得到满足
4. **用户体验差**: 用户被迫使用可能不匹配其工作流程的预定义选项

### 解决方案

通过创建可配置的主数据管理界面，使管理员能够：

- 自定义设备位置、故障代码、工单分类等系统参数
- 实时更新系统配置而无需重新部署
- 为组织特定需求提供灵活的术语和分类
- 维护历史数据完整性同时启用新配置

### 预期收益

- **提升运营效率**: 管理员可自主配置系统，减少IT依赖
- **增强系统适应性**: 系统可适应不同组织的特定需求
- **改善用户体验**: 用户使用符合其工作流程的定制化选项
- **降低维护成本**: 减少因主数据变更而需要的代码修改

## 功能需求

### 核心功能

1. **主数据管理界面**
   - 设备位置管理 (当前为Asset.location自由文本字段)
   - 故障代码管理 (当前为FaultCode枚举)
   - 工单分类管理 (当前在表单中硬编码)
   - 工单原因管理 (当前在验证中硬编码)
   - 优先级管理 (当前为Priority枚举，可选配置)

2. **CRUD操作支持**
   - 新增条目 (名称和描述字段)
   - 编辑现有条目 (带引用验证)
   - 激活/停用条目 (软删除保留历史数据)
   - 查看使用统计 (引用此条目的工单/资产数量)

3. **数据库集成**
   - 将现有枚举字段转换为可配置主数据表的引用
   - 维护数据完整性和外键关系
   - 提供数据迁移脚本保持向后兼容

### 集成需求

4. **现有表单兼容性**
   - 工单创建和编辑表单继续正常工作
   - 下拉选项从主数据表而非硬编码枚举填充
   - 与工单验证系统集成，保持当前验证规则

5. **UI组件一致性**
   - 遵循User Management和Asset Management页面的shadcn/ui组件模式
   - 与现有导航系统集成
   - 为适当角色提供Settings链接

## 技术规范

### 架构设计

**现有系统集成**:
- 前端: Next.js 14 与 shadcn/ui 组件
- 后端: Express.js 微服务架构
- 数据库: PostgreSQL 与 Prisma ORM
- 认证: JWT 基于角色的访问控制

**关键集成点**:
- 工单验证系统 (`/apps/api/work-order-service/src/utils/validation.ts`)
- UI下拉组件 (工单和资产表单)
- 数据库架构枚举 (FaultCode, Priority等)
- 导航系统 (`/apps/web/components/layout/Navigation.tsx`)

### 数据模型

**新增主数据表**:
```sql
-- 故障代码表
Table FaultCodes {
  id: String (primary key)
  name: String
  description: String?
  isActive: Boolean
  createdAt: DateTime
  updatedAt: DateTime
}

-- 设备位置表  
Table Locations {
  id: String (primary key)
  name: String
  description: String?
  isActive: Boolean
  createdAt: DateTime
  updatedAt: DateTime
}

-- 工单分类表
Table Categories {
  id: String (primary key)
  name: String
  description: String?
  isActive: Boolean
  createdAt: DateTime
  updatedAt: DateTime
}
```

### API设计

**新增端点**:
- `GET /api/settings/fault-codes` - 获取故障代码列表
- `POST /api/settings/fault-codes` - 创建新故障代码
- `PUT /api/settings/fault-codes/:id` - 更新故障代码
- `DELETE /api/settings/fault-codes/:id` - 软删除故障代码
- (类似的端点适用于locations, categories等)

## 实施策略

### 开发方法

采用**增量式迁移**方法:

1. **阶段1**: 创建新主数据表和API端点
2. **阶段2**: 实现管理界面组件
3. **阶段3**: 更新表单组件使用动态选项
4. **阶段4**: 迁移现有枚举数据到主数据表
5. **阶段5**: 验证和回归测试

### 兼容性保证

- 数据库迁移保留所有现有数据
- API接口保持向后兼容
- 现有工单工作流程零中断
- 渐进式特性开关支持安全部署

## 验收标准

### 功能验收

1. ✅ **管理界面完整**: 所有主数据类型支持完整CRUD操作
2. ✅ **集成验证**: 工单表单使用动态主数据，无破坏性变更
3. ✅ **现有功能保持**: 工单创建、编辑、筛选正常工作
4. ✅ **模式一致性**: 遵循现有模式和标准 (shadcn/ui组件, API控制器模式)

### 质量验收

5. ✅ **测试覆盖**: 现有和新增API/组件测试通过
6. ✅ **文档更新**: 导航结构、API端点文档更新 (如适用)
7. ✅ **性能验证**: 主数据查找对响应时间影响可忽略
8. ✅ **角色验证**: 仅SUPERVISOR和ADMIN角色可访问设置功能

## 风险评估与缓解

### 主要风险

**风险**: 数据库架构变更可能破坏现有工单验证并造成数据不一致

**缓解措施**:
- 实施全面迁移脚本保留现有枚举值作为初始主数据条目
- 添加数据库约束确保引用完整性
- 使用特性开关逐步推出从枚举到表的转换
- 更新验证架构检查主数据表而非枚举

**回滚计划**:
- 保留原始枚举值的备份
- 数据库迁移可通过恢复枚举字段和删除主数据表来逆转
- 如果API端点失败，前端组件可回退到硬编码值

### 质量保证

- 现有工单工作流程的综合回归测试
- 数据迁移和回滚程序的测试验证
- 主数据查找的性能影响评估
- 跨浏览器和设备的兼容性测试

## 故事分解

### 故事 7.1: 系统设置管理界面

**目标**: 创建全面的主数据管理界面，让管理员配置设备位置、故障代码、工单分类等系统参数，将硬编码枚举转换为动态数据库表，同时保持完全向后兼容性。

**估计**: 3-4小时专注开发
- 数据库架构: 45分钟
- 后端API: 90分钟  
- 前端界面: 90分钟
- 集成测试: 30分钟

## 成功标准

史诗创建成功的标准:

1. ✅ 增强范围清晰定义且大小适当 (单一聚焦故事)
2. ✅ 集成方法简单直接且低风险 (遵循现有User Management模式)
3. ✅ 现有系统模式已识别并将被遵循 (shadcn/ui组件, Controller-Service-Repository)
4. ✅ 回滚计划简单可行 (数据库迁移可逆，前端回退机制)
5. ✅ 验收标准包含现有功能验证 (工单工作流程回归测试)

## 变更记录

| 日期 | 版本 | 描述 | 作者 |
|------|------|------|------|
| 2025-08-17 | 1.0 | 创建Epic 7用于系统配置和主数据管理 | Claude (brownfield-create-epic task) |

## 备注

此史诗解决了将Story 5.2从Epic 5范围移至专门用于系统配置和主数据管理的专用史诗的需求。通过提供可配置的主数据管理功能，消除了系统中的硬编码值，为管理员提供了自助配置能力，提高了不同组织需求的系统灵活性。

该史诗遵循既定模式，无需架构变更，是棕地增强过程的理想候选。