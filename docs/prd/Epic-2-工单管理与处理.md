# 2. 史诗详情 - Epic 2: 工单管理与处理

## 史诗概述

**史诗目标**: 这个史诗的核心目标是为维修技术员和主管提供一个完整的工单处理闭环。当这个史诗完成后，一个报修单从被创建开始，可以被顺利地指派、接收、处理、更新，直到最终完成归档，整个过程都在线上清晰可见。此外，系统将支持完整的跨平台照片管理功能，确保移动端采集的维修照片能够在PC端无缝查看和管理，为维修记录提供完整的可视化文档支持。

**史诗类型**: Core Business Process Epic (核心业务流程史诗)

**估计工作量**: 5 个故事

## 业务价值

### 问题陈述

当前维修工单的处理流程缺乏系统性管理，存在以下问题：
1. **分配不透明**: 工单分配没有明确规则，效率低下
2. **状态跟踪困难**: 工单处理进度不透明，难以监控
3. **记录不完整**: 维修解决方案和历史记录缺失
4. **跨平台协作差**: 移动端和PC端数据不同步

### 解决方案

通过建立完整的工单管理流程，实现从工单分配到完成归档的全生命周期管理，包括智能分配、实时状态跟踪、完整记录归档和跨平台照片管理。

### 预期收益

- **提升分配效率**: 自动分配规则减少手动派工时间50%
- **增强过程透明度**: 实时状态跟踪提升工单处理可见性
- **完善维修档案**: 完整的解决方案记录为设备维护提供历史参考
- **优化跨平台协作**: 移动端和PC端无缝数据同步

## 功能需求

### 核心功能

1. **智能工单分配**
   - 基于规则的自动分配系统
   - 手动分配和调整功能
   - 技术员负载均衡
   - 实时通知机制

2. **工单状态管理**
   - 多状态工单生命周期管理
   - 实时状态更新和跟踪
   - 状态变更历史记录
   - 处理时间统计

3. **解决方案记录**
   - 详细解决方案描述
   - 故障代码分类
   - 完成照片上传
   - 自动归档到资产历史

4. **跨平台照片管理**
   - 服务器端照片存储
   - PC端照片查看和管理
   - 缩略图生成和优化
   - 权限控制的照片访问

5. **历史记录追踪**
   - 完整的工单处理时间线
   - 状态变更记录
   - 处理效率统计
   - 多维度分析报告

## 技术规范

### 架构设计

**服务集成**:
- 工单服务(work-order-service)
- 用户服务(user-service)集成
- 文件存储服务
- 通知服务

**数据流设计**:
- 工单创建 → 自动分配 → 状态跟踪 → 完成归档
- 照片上传 → 服务器存储 → 跨平台访问

### 数据模型扩展

**工单分配规则**:
```sql
Table AssignmentRule {
  id: String (primary key)
  name: String
  assetCategory: String?
  location: String?
  technicianId: String (foreign key)
  isActive: Boolean
  priority: Int
  createdAt: DateTime
  updatedAt: DateTime
}
```

**工单状态历史**:
```sql
Table WorkOrderHistory {
  id: String (primary key)
  workOrderId: String (foreign key)
  fromStatus: WorkOrderStatus?
  toStatus: WorkOrderStatus
  changedBy: String (foreign key)
  changedAt: DateTime
  notes: String?
}
```

**照片管理**:
```sql
Table WorkOrderPhoto {
  id: String (primary key)
  workOrderId: String (foreign key)
  fileName: String
  filePath: String
  fileSize: Int
  mimeType: String
  photoType: PhotoType (PROBLEM, SOLUTION)
  uploadedBy: String (foreign key)
  uploadedAt: DateTime
}
```

### API设计扩展

**工单分配端点**:
- `POST /api/work-orders/:id/assign` - 分配工单
- `GET /api/assignment-rules` - 获取分配规则
- `POST /api/assignment-rules` - 创建分配规则

**工单状态端点**:
- `PATCH /api/work-orders/:id/status` - 更新工单状态
- `GET /api/work-orders/:id/history` - 获取状态历史

**照片管理端点**:
- `POST /api/work-orders/:id/photos` - 上传工单照片
- `GET /api/work-orders/:id/photos` - 获取工单照片列表
- `GET /api/photos/:id` - 获取照片文件

## 故事分解

### 故事 2.1: 工单分配与通知

**作为一个** 设备部门主管,
**我想要** 系统能根据预设规则（如设备、区域、类别）自动分配新工单，并支持我手动调整,
**以便于** 提升派工效率，确保每个任务都有明确的负责人。

**验收标准**:
- 系统后台应提供一个简单的规则配置界面，用于设定自动派工的条件
- 当新报修请求符合规则时，系统自动将其分配给指定的技术员
- 被分配的技术员会收到新任务的通知
- 主管可以在 Web 管理端手动将工单指派或改派给任何技术员

### 故事 2.2: (Web/移动端) 工单处理与状态更新

**作为一个** 维修技术员,
**我想要** 在我的任务列表中查看工单，并能在执行过程中随时更新其状态,
**以便于** 高效管理我的工作，并让所有相关人员了解最新进展。

**验收标准**:
- 技术员登录后，可以在 Web 端和移动端看到一个"我的任务"列表
- 技术员可以打开工单详情，查看所有报修信息、设备历史和附加文档
- 技术员可以将工单状态从"待处理"更新为"进行中"或"等待备件"等
- 工单状态的任何变更都会被记录，并对主管可见

### 故事 2.3: (Web/移动端) 记录解决方案与完成工单

**作为一个** 维修技术员,
**我想要** 在维修完成后，方便地记录解决方案、填写故障代码并上传完成照片,
**以便于** 为设备建立完整的维护档案，并正式关闭工单。

**验收标准**:
- 在工单详情页，技术员可以将工单标记为"已完成"
- 标记完成时，需要填写解决方案描述、选择故障代码（可选）
- 技术员可以上传维修完成后的照片作为证明
- 工单关闭后，所有相关信息会自动归档到对应资产的维护历史中

### 故事 2.4: 工单状态跟踪与历史记录

**作为一个** 设备部门主管,
**我想要** 能够查看工单的完整状态变更历史和处理时间线,
**以便于** 监控处理效率并进行流程优化分析。

**验收标准**:
- 每个工单的状态变更都有完整的时间戳和操作人记录
- 主管可以查看工单从创建到关闭的完整时间线
- 系统能够生成工单处理时间的统计报告
- 支持按时间段、技术员、设备类型等维度进行处理效率分析

### 故事 2.5: 工单照片存储与跨平台显示

**作为一个** 维修技术员和设备主管,
**我想要** 移动端拍摄的工单照片能够安全存储到服务器，并且PC端能够查看和管理这些照片,
**以便于** 维修记录更加完整，跨平台协作更高效，照片资料便于长期存档和分析。

**验收标准**:
- 移动端用户能够在创建工单时上传设备故障照片到服务器
- 移动端用户能够在工单完成时上传维修后的解决方案照片到服务器
- PC端用户能够查看移动端上传的所有工单相关照片（故障照片和解决方案照片）
- 照片存储系统按年月自动分类，支持缩略图生成和全尺寸查看
- 照片访问具有适当的权限控制，只有相关工单的参与者才能查看照片

## 验收标准

### 功能验收

1. ✅ **分配系统完整**: 自动分配规则正确工作，手动分配功能完善
2. ✅ **状态管理流畅**: 工单状态可以正确更新，历史记录完整
3. ✅ **解决方案记录**: 技术员可以完整记录维修解决方案和上传照片
4. ✅ **跨平台协作**: 移动端和PC端数据同步，照片正确显示

### 质量验收

5. ✅ **性能优化**: 照片上传和显示性能良好，不影响用户体验
6. ✅ **数据完整性**: 工单状态变更和历史记录数据完整准确
7. ✅ **权限控制**: 照片访问权限正确，数据安全有保障
8. ✅ **用户体验**: 跨平台操作流畅，界面响应及时

## 风险评估与缓解

### 主要风险

**风险**: 跨平台照片同步可能存在性能和存储压力

**缓解措施**:
- 实施照片压缩和缩略图生成
- 设计合理的存储策略和清理机制
- 监控存储使用情况和性能指标

**风险**: 工单分配规则复杂度可能导致分配错误

**缓解措施**:
- 设计简单明确的规则优先级机制
- 提供分配预览和手动调整功能
- 建立分配日志和回滚机制

### 质量保证

- 工单状态变更的完整性测试
- 照片上传和显示的性能测试
- 跨平台数据同步的一致性验证
- 分配规则的逻辑正确性测试

## 成功标准

史诗完成的标准:

1. ✅ 工单处理流程完整且高效
2. ✅ 跨平台协作体验流畅
3. ✅ 维修记录完整且可追溯
4. ✅ 系统性能和稳定性满足要求
5. ✅ 用户满意度和操作效率显著提升

## 变更记录

| 日期 | 版本 | 描述 | 作者 |
|------|------|------|------|
| 2025-08-17 | 1.0 | 从综合史诗详情文档中提取创建独立Epic 2文件 | John, PM |

## 备注

此史诗是系统核心业务流程的关键组成部分，其完成质量直接影响用户的日常工作效率和系统的整体价值。重点关注跨平台用户体验的一致性和数据同步的可靠性。