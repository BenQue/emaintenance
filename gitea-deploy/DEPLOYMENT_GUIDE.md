# E-Maintenance Gitea CI/CD Deployment Guide

## Overview

This guide provides a complete solution for deploying the E-Maintenance System using Gitea as the source code repository with automated CI/CD pipelines, zero-downtime deployments, and comprehensive monitoring.

## Architecture

```
┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐
│   Gitea Server  │    │  Production     │    │   Monitoring    │
│                 │    │     Server      │    │     System      │
│ ┌─────────────┐ │    │ ┌─────────────┐ │    │ ┌─────────────┐ │
│ │ Repository  │ │    │ │ Blue/Green  │ │    │ │ Health      │ │
│ │ Actions     │ │───▶│ │ Deployment  │ │───▶│ │ Monitoring  │ │
│ │ Webhooks    │ │    │ │ Docker      │ │    │ │ Alerting    │ │
│ └─────────────┘ │    │ └─────────────┘ │    │ └─────────────┘ │
└─────────────────┘    └─────────────────┘    └─────────────────┘
```

## Quick Start

### 1. Initial Setup (10 minutes)

```bash
# Clone your repository to Gitea
git remote add gitea git@gitea.yourdomain.com:your-org/emaintenance.git
git push gitea main

# Generate secrets
cd gitea-deploy
chmod +x generate-gitea-secrets.sh
./generate-gitea-secrets.sh

# Set up secrets in Gitea (via UI or CLI)
chmod +x gitea-secrets-commands.sh
./gitea-secrets-commands.sh
```

### 2. Production Server Setup (15 minutes)

```bash
# On production server
mkdir -p /opt/emaintenance
cd /opt/emaintenance

# Clone repository
git clone git@gitea.yourdomain.com:your-org/emaintenance.git .

# Copy environment file (generated by secrets script)
scp .env.production user@production-server:/opt/emaintenance/docker-deploy/

# Run initial deployment
cd docker-deploy
./deploy-secure.sh
```

### 3. Enable CI/CD (5 minutes)

```bash
# Configure webhook in Gitea
# URL: http://your-server:9000/deploy
# Secret: Use WEBHOOK_SECRET from secrets

# Start webhook listener
cd /opt/emaintenance/gitea-deploy
chmod +x deploy-webhook.sh
./deploy-webhook.sh server
```

## Detailed Components

### 1. Repository Structure

```
emaintenance/
├── .gitea/
│   └── workflows/
│       ├── ci.yml           # Continuous Integration
│       └── deploy.yml       # Deployment Pipeline
├── gitea-deploy/
│   ├── GITEA_SETUP_GUIDE.md
│   ├── deploy-webhook.sh    # Webhook handler
│   ├── zero-downtime-deploy.sh
│   ├── rollback.sh
│   ├── health-monitor.sh
│   ├── generate-gitea-secrets.sh
│   └── secrets-template.env
└── docker-deploy/          # Existing Docker configs
```

### 2. CI/CD Pipeline Features

#### Continuous Integration (`.gitea/workflows/ci.yml`)
- **Code Quality**: Linting, type checking, formatting
- **Testing**: Unit tests, integration tests, coverage reports
- **Security**: Vulnerability scanning with Trivy
- **Docker**: Multi-platform image building
- **Database**: Migration validation

#### Deployment Pipeline (`.gitea/workflows/deploy.yml`)
- **Pre-deployment**: Validation, testing, backup creation
- **Zero-downtime**: Blue-green deployment strategy
- **Health Checks**: Comprehensive service validation
- **Rollback**: Automatic rollback on failure
- **Notifications**: Slack/Discord integration

### 3. Deployment Strategies

#### A. Traditional Deployment
```bash
# Manual deployment
cd /opt/emaintenance
git pull origin main
cd docker-deploy
./deploy-secure.sh
```

#### B. Webhook-triggered Deployment
```bash
# Automatic deployment on git push
# Configured via Gitea webhook settings
# Handles: main branch pushes, tag releases
```

#### C. Zero-downtime Blue-Green Deployment
```bash
# Run blue-green deployment
cd /opt/emaintenance/gitea-deploy
./zero-downtime-deploy.sh deploy
```

### 4. Secrets Management

#### Gitea Secrets Required:
- `DB_PASSWORD`: Database password
- `JWT_SECRET`: JWT signing secret  
- `REDIS_PASSWORD`: Redis password
- `ADMIN_PASSWORD`: Admin user password
- `DEPLOY_HOST`: Production server hostname
- `DEPLOY_USER`: Deployment user
- `DEPLOY_SSH_KEY`: SSH private key (base64 encoded)
- `WEBHOOK_SECRET`: Webhook validation secret
- `NOTIFICATION_WEBHOOK`: Alert webhook URL

#### Security Best Practices:
- Rotate secrets every 90 days
- Use strong passwords (16+ characters)
- Enable 2FA on Gitea accounts
- Limit SSH key access
- Monitor secret usage

### 5. Monitoring and Health Checks

#### Health Monitoring Features:
- Service endpoint monitoring
- Container health checks
- System resource monitoring (CPU, memory, disk)
- Database connectivity validation
- Log error analysis
- Response time tracking

#### Setup Monitoring:
```bash
# Install monitoring as cron job
crontab -e
# Add: */5 * * * * /opt/emaintenance/gitea-deploy/health-monitor.sh monitor

# Or run as systemd service
sudo cp health-monitor.service /etc/systemd/system/
sudo systemctl enable health-monitor
sudo systemctl start health-monitor
```

#### Alert Channels:
- Webhook notifications (Slack, Discord, Teams)
- Log file alerts
- Email notifications (when configured)

### 6. Rollback Procedures

#### Quick Rollback Options:

```bash
# 1. Automatic rollback (during failed deployment)
# Happens automatically if health checks fail

# 2. Manual quick rollback
cd /opt/emaintenance/gitea-deploy
./rollback.sh quick

# 3. Rollback to specific version
./rollback.sh version v1.2.0

# 4. Restore from backup
./rollback.sh backup backup-20250822-143000

# 5. Interactive rollback menu
./rollback.sh interactive
```

## Production Deployment Workflow

### Standard Deployment Process

1. **Development**
   ```bash
   # Feature development on feature branch
   git checkout -b feature/new-feature
   # ... make changes ...
   git push origin feature/new-feature
   # Create PR to develop branch
   ```

2. **Integration Testing**
   ```bash
   # Merge to develop triggers CI pipeline
   # Runs tests, builds images, security scans
   ```

3. **Release Preparation**
   ```bash
   # Create release branch
   git checkout -b release/v1.3.0 develop
   # Final testing and bug fixes
   git tag v1.3.0
   git push origin v1.3.0
   ```

4. **Production Deployment**
   ```bash
   # Merge to main triggers deployment pipeline
   # Automatic deployment with health checks
   # Notification sent on completion
   ```

### Emergency Deployment

```bash
# Skip tests for emergency fixes
# Trigger via Gitea Actions UI with skip_tests=true
# Or manual deployment:
cd /opt/emaintenance
git pull origin main
cd docker-deploy
./deploy-secure.sh
```

## Troubleshooting

### Common Issues and Solutions

#### 1. Deployment Failures
```bash
# Check deployment logs
tail -f /var/log/emaintenance/webhook-deploy.log

# Check Docker container status
docker ps --filter "name=emaintenance"

# Check service health
./health-monitor.sh status
```

#### 2. Service Not Responding
```bash
# Restart specific service
docker restart emaintenance_user-service_1

# Check service logs
docker logs emaintenance_user-service_1 --tail 100

# Full system restart
cd /opt/emaintenance/docker-deploy
docker-compose -f docker-compose.production.yml restart
```

#### 3. Database Issues
```bash
# Check database connectivity
docker exec emaintenance_postgres_1 pg_isready -U postgres

# View database logs
docker logs emaintenance_postgres_1 --tail 100

# Restore from backup
./rollback.sh backup latest-backup-name
```

#### 4. Network Connectivity
```bash
# Test internal service communication
docker exec emaintenance_web_1 curl http://user-service:3001/health

# Check nginx configuration
docker exec emaintenance_nginx_1 nginx -t

# Reload nginx
docker exec emaintenance_nginx_1 nginx -s reload
```

### Performance Optimization

#### 1. Docker Performance
```bash
# Clean up unused resources
docker system prune -f

# Optimize image sizes
# Use multi-stage builds (already implemented)

# Monitor resource usage
docker stats
```

#### 2. Database Optimization
```bash
# Check database performance
docker exec emaintenance_postgres_1 psql -U postgres -d emaintenance \
  -c "SELECT * FROM pg_stat_activity WHERE state = 'active';"

# Vacuum database
docker exec emaintenance_postgres_1 psql -U postgres -d emaintenance \
  -c "VACUUM ANALYZE;"
```

#### 3. Application Performance
```bash
# Monitor response times
./health-monitor.sh metrics

# Check memory usage
docker exec emaintenance_user-service_1 node --expose-gc -e "
  global.gc(); 
  console.log(process.memoryUsage());
"
```

## Security Considerations

### 1. Network Security
- Use Docker networks for service isolation
- Configure firewall rules
- Enable SSL/TLS for external access
- Implement rate limiting

### 2. Container Security
- Run containers as non-root users
- Use minimal base images
- Regular security updates
- Vulnerability scanning in CI/CD

### 3. Data Security
- Encrypt sensitive data at rest
- Secure backup storage
- Regular secret rotation
- Access logging and monitoring

### 4. Access Control
- SSH key-based authentication
- Limited sudo access
- Role-based deployment permissions
- Audit trail for deployments

## Monitoring and Metrics

### Key Metrics to Monitor

1. **Application Metrics**
   - Response times
   - Error rates
   - Request volumes
   - User sessions

2. **Infrastructure Metrics**
   - CPU usage
   - Memory usage
   - Disk space
   - Network I/O

3. **Business Metrics**
   - Active users
   - Work orders processed
   - System uptime
   - Feature usage

### Dashboard Setup

```bash
# Optional: Set up Grafana dashboard
# Import dashboard configuration
# Connect to metrics endpoints

# View current metrics
./health-monitor.sh metrics | jq '.'
```

## Maintenance Tasks

### Daily Tasks
- Check system health status
- Review deployment logs
- Monitor resource usage
- Verify backup completion

### Weekly Tasks
- Update security patches
- Review performance metrics
- Test rollback procedures
- Validate monitoring alerts

### Monthly Tasks
- Rotate secrets and passwords
- Review access logs
- Update documentation
- Disaster recovery testing

## Support and Contact

### Getting Help
1. Check logs: `/var/log/emaintenance/`
2. Review health status: `./health-monitor.sh status`
3. Check Gitea Actions logs
4. Review Docker container logs

### Documentation Updates
- Keep deployment guide current
- Document configuration changes
- Update troubleshooting procedures
- Maintain runbook accuracy

---

**Note**: This deployment solution provides production-ready CI/CD with Gitea, including automated testing, security scanning, zero-downtime deployments, comprehensive monitoring, and reliable rollback procedures. Regular maintenance and monitoring ensure optimal performance and security.