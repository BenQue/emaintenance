# E-Maintenance Docker Deployment

Secure production deployment configuration for the E-Maintenance System.

## ğŸš€ Quick Start

1. **Generate secure environment configuration:**

   ```bash
   ./generate-passwords.sh
   ```

2. **Deploy the system:**

   ```bash
   ./deploy-secure.sh
   ```

3. **Access the application:**
   - Web App: `http://YOUR_SERVER_IP:3030`
   - Admin Login: Check the generated credentials file

## ğŸ“ Directory Structure

```text
docker-deploy/
â”œâ”€â”€ deploy-secure.sh              # Main deployment script
â”œâ”€â”€ generate-passwords.sh         # Secure password generator  
â”œâ”€â”€ docker-compose.production.yml # Production Docker Compose config
â”œâ”€â”€ .env.production.secure        # Environment template (secure)
â”œâ”€â”€ database/
â”‚   â”œâ”€â”€ init/                    # Database initialization scripts
â”‚   â””â”€â”€ seeds/                   # Sample data seed files
â”œâ”€â”€ docker-files/                # Custom Docker build files
â”œâ”€â”€ nginx/                       # Nginx reverse proxy configuration
â”œâ”€â”€ scripts/                     # Utility scripts (backup, monitoring)
â””â”€â”€ DEPLOYMENT_GUIDE.md          # Comprehensive deployment guide
```

## ğŸ”’ Security Features

- **Secure password generation** with strong defaults
- **Environment file protection** - never commits passwords to Git
- **Database encryption** and secure connection strings  
- **Rate limiting** and API protection
- **Automated backups** with retention management
- **Health checks** and monitoring
- **Proper volume management** with secure permissions

## ğŸ“‹ Key Files

| File | Purpose | Security Level |
|------|---------|---------------|
| `.env.production.secure` | Environment template | âœ… Safe to commit |
| `.env.production` | Actual environment config | ğŸš¨ NEVER commit |
| `credentials-*.txt` | Generated login credentials | ğŸš¨ Store securely, then delete |
| `deploy-secure.sh` | Main deployment script | âœ… Safe to commit |
| `generate-passwords.sh` | Password generator | âœ… Safe to commit |

## âš¡ Commands

```bash
# Generate environment configuration
./generate-passwords.sh

# Deploy system
./deploy-secure.sh

# Check service status
docker-compose -f docker-compose.production.yml ps

# View logs
docker-compose -f docker-compose.production.yml logs -f [service-name]

# Manual database backup
docker exec emaintenance-db-backup-1 /backup-database.sh

# Stop all services
docker-compose -f docker-compose.production.yml down

# Start all services
docker-compose -f docker-compose.production.yml up -d
```

## ğŸ”§ Configuration

### Environment Variables

Key configuration options in `.env.production`:

- `DB_PASSWORD` - Database password (auto-generated)
- `JWT_SECRET` - JWT signing secret (auto-generated)  
- `REDIS_PASSWORD` - Redis password (auto-generated)
- `ADMIN_PASSWORD` - Initial admin password (auto-generated)
- `SERVER_IP` - Your server's IP address
- `HTTP_PORT` - Web application port (default: 3030)

### Service Ports

- **3030**: Web application (Nginx)
- **3031**: User Service API
- **3032**: Work Order Service API
- **3033**: Asset Service API

### Data Volumes

- `/opt/e-maintenance/data/` - Application data
- `/opt/e-maintenance/logs/` - Application logs
- `/opt/e-maintenance/backups/` - Database backups

## ğŸ› ï¸ Troubleshooting

### Check Service Health

```bash
# All services
docker-compose -f docker-compose.production.yml ps

# Specific service logs
docker-compose -f docker-compose.production.yml logs postgres
docker-compose -f docker-compose.production.yml logs web
```

### Common Issues

1. **Port conflicts**: Ensure ports 3030-3033 are available
2. **Disk space**: Requires minimum 10GB free space
3. **Memory**: Requires minimum 4GB available RAM
4. **Permissions**: User must have Docker access (`docker` group)

### Emergency Recovery

```bash
# Complete restart
docker-compose -f docker-compose.production.yml down
docker-compose -f docker-compose.production.yml up -d

# Database recovery from backup
gunzip -c /opt/e-maintenance/backups/postgres/e-maintenance_latest.sql.gz | \
    docker exec -i e-maintenance-postgres-1 psql -U postgres -d postgres
```

## ğŸ“– Documentation

- **[DEPLOYMENT_GUIDE.md](./DEPLOYMENT_GUIDE.md)** - Complete deployment guide
- **[SECURITY.md](./SECURITY.md)** - Security best practices
- **[TROUBLESHOOTING.md](./TROUBLESHOOTING.md)** - Detailed troubleshooting

## ğŸš¨ Security Warnings

- **NEVER** commit `.env.production` to version control
- **ALWAYS** change default passwords after deployment
- **SECURE** the credentials file generated by `generate-passwords.sh`
- **REGULARLY** update passwords and JWT secrets
- **MONITOR** access logs and failed login attempts

## ğŸ“ Support

For deployment issues:

1. Check the deployment log: `/opt/e-maintenance/logs/deploy-[timestamp].log`
2. Review service logs: `docker-compose -f docker-compose.production.yml logs`
3. Verify environment configuration: `source .env.production && env | grep -E "(DB_|JWT_|REDIS_)"`
4. Test database connectivity: `docker exec e-maintenance-postgres-1 pg_isready -U postgres`

---

**Production Ready**: This deployment configuration is designed for production use with proper security, monitoring, and backup procedures.
